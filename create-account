#!/bin/bash

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒé€”ä¸­ã§å¤±æ•—ã—ãŸå ´åˆã«çµ‚äº†ã™ã‚‹
set -e

# --- è¨­å®š ---
# ç¬¬1å¼•æ•°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã—ã¦ä½¿ç”¨
USERNAME=${1:-my-new-user}
OUTPUT_FILE="${USERNAME}-kubeconfig"
ADMIN_KUBECONFIG="/etc/kubernetes/admin.conf"
CSR_NAME="${USERNAME}-csr"

# ç’°å¢ƒå¤‰æ•°ã§admin.confã‚’æŒ‡å®š
export KUBECONFIG="${ADMIN_KUBECONFIG}"

# å®Ÿè¡Œæ¨©é™ã®ç¢ºèª
if [[ ! -r "${ADMIN_KUBECONFIG}" ]]; then
    echo "ã‚¨ãƒ©ãƒ¼: ${ADMIN_KUBECONFIG} ãŒèª­ã¿å–ã‚Šå¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

echo "ğŸŒŸ ${ADMIN_KUBECONFIG}ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${USERNAME} ã®kubeconfigã‚’ç”Ÿæˆã—ã¾ã™ã€‚"

# kubectlã®å®Ÿè¡Œå¯èƒ½æ€§ã‚’ç¢ºèª
if ! command -v kubectl &> /dev/null; then
    echo "ã‚¨ãƒ©ãƒ¼: kubectlã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ãŒé€šã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

# --- 1. ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆ ---
echo "--- ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
kubectl create namespace "${USERNAME}" --dry-run=client -o yaml | kubectl apply -f -

# --- 2. ç§˜å¯†éµã¨CSRã®ç”Ÿæˆ ---
echo "--- ç§˜å¯†éµã¨CSRã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç§˜å¯†éµã‚’ç”Ÿæˆ
openssl genrsa -out "${USERNAME}.key" 2048
# CSRã‚’ç”Ÿæˆ (Common Nameã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ã€Organizationã‚’ã‚°ãƒ«ãƒ¼ãƒ—åã«è¨­å®š)
openssl req -new -key "${USERNAME}.key" -out "${USERNAME}.csr" -subj "/CN=${USERNAME}/O=${USERNAME}"

# CSRã®å†…å®¹ã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
CSR_CONTENT=$(cat "${USERNAME}.csr" | base64 | tr -d '\n')

# --- 3. CSRãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ ---
echo "--- CertificateSigningRequestãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
kubectl apply -f - <<EOF
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ${CSR_NAME}
spec:
  request: ${CSR_CONTENT}
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 31536000  # 1å¹´
  usages:
  - digital signature
  - key encipherment
  - client auth
EOF

# --- 4. CSRã®æ‰¿èªã¨å¾…æ©Ÿ ---
echo "--- CSRã‚’æ‰¿èªã—ã¦ã„ã¾ã™..."
kubectl certificate approve "${CSR_NAME}"

# è¨¼æ˜æ›¸ãŒç™ºè¡Œã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ãƒ«ãƒ¼ãƒ—
echo "--- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã®ç™ºè¡Œã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™..."
MAX_RETRIES=10
RETRY_COUNT=0
while [ ${RETRY_COUNT} -lt ${MAX_RETRIES} ]; do
    CLIENT_CERT=$(kubectl get csr "${CSR_NAME}" -o jsonpath='{.status.certificate}' 2>/dev/null || echo "")
    if [ -n "${CLIENT_CERT}" ]; then
        echo "âœ… è¨¼æ˜æ›¸ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚"
        break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    echo "è¨¼æ˜æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™... (${RETRY_COUNT}/${MAX_RETRIES})"
    sleep 2
done

if [ -z "${CLIENT_CERT}" ]; then
    echo "ã‚¨ãƒ©ãƒ¼: è¨¼æ˜æ›¸ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

# Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
echo "${CLIENT_CERT}" | base64 --decode > "${USERNAME}.crt"

# --- 5. RBACã®ãŸã‚ã®Roleã¨RoleBindingã®ä½œæˆ ---
# ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒåŒã˜ã§ã‚ã‚‹å‰æ
echo "--- RBACã®å½¹å‰²ã¨ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ã„ã¾ã™..."
kubectl apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ${USERNAME}-role
  namespace: ${USERNAME}
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
EOF

kubectl apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ${USERNAME}-binding
  namespace: ${USERNAME}
subjects:
- kind: User
  apiGroup: rbac.authorization.k8s.io
  name: ${USERNAME}
roleRef:
  kind: Role
  name: ${USERNAME}-role
  apiGroup: rbac.authorization.k8s.io
EOF

# --- 6. kubeconfigãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ ---
echo "--- ${OUTPUT_FILE}ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."

# --rawã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦clusteræƒ…å ±ã‚’å–å¾—
CLUSTER_NAME=$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].name}')
CLUSTER_SERVER=$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.server}')
CLUSTER_CA_DATA=$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')

# è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
CLIENT_CERT_DATA=$(cat "${USERNAME}.crt" | base64 | tr -d '\n')
CLIENT_KEY_DATA=$(cat "${USERNAME}.key" | base64 | tr -d '\n')

cat <<EOF > "${OUTPUT_FILE}"
apiVersion: v1
kind: Config
clusters:
- name: ${CLUSTER_NAME}
  cluster:
    server: ${CLUSTER_SERVER}
    certificate-authority-data: ${CLUSTER_CA_DATA}
users:
- name: ${USERNAME}
  user:
    client-certificate-data: ${CLIENT_CERT_DATA}
    client-key-data: ${CLIENT_KEY_DATA}
contexts:
- name: ${USERNAME}-context
  context:
    cluster: ${CLUSTER_NAME}
    user: ${USERNAME}
    namespace: ${USERNAME}
current-context: ${USERNAME}-context
EOF

echo "âœ… kubeconfigãƒ•ã‚¡ã‚¤ãƒ« '${OUTPUT_FILE}' ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
echo "âœ… é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«: ${USERNAME}.key, ${USERNAME}.crt"
echo "ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…±æœ‰ã§ãã¾ã™ã€‚"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (CSRãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤)
echo "--- CertificateSigningRequestãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
kubectl delete csr "${CSR_NAME}"
rm ${USERNAME}.key ${USERNAME}.crt ${USERNAME}.csr

echo "å®Œäº†ã—ã¾ã—ãŸã€‚"
